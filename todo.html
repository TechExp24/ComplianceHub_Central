<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nothing to do? List</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* === 50/50 split with a thin vertical line (center) === */
    /* === 50/50 split with a persistent thin vertical divider === */
    .twocol{
    max-width:1160px;
    margin:1.2rem auto;
    display:grid;
    grid-template-columns: 1fr 1px 1fr;  /* left | line | right */
    gap:1rem;
    align-items:stretch;
    }
    .vline{
    width:1px;
    height:auto;                 /* stretches with tallest column */
    background:#000;
    opacity:.6;
    }

    .list-col { min-height: 60vh; }
    .list-title { font-weight: 800; color: #000; text-align: center; margin: .25rem 0 .5rem 0; }

    /* Task cards match your white tiles */
    .task {
      background: #fff; border-radius: 16px; padding: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.15); margin: 0 0 .75rem 0;
      user-select: none; cursor: pointer;
    }
    .task-head{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    .task-title{ font-weight:800; color:#000; }
    .badge { font-size: .85rem; padding: .15rem .5rem; border-radius: 999px; background:#eaeaea; color:#000; white-space:nowrap; }
    .badge.warn{ background:#ffe0e0; }
    .meta { margin-top: .4rem; font-size: .9rem; color:#333; }
    .meta .who { font-weight: 700; }
    .meta .date { opacity:.8; }
    .empty {
      opacity: .7; background: #f5f5f5; border: 1px dashed #ccc;
      padding: 14px; border-radius: 12px; text-align: center; font-weight: 600;
    }

    /* Mobile: stack columns, keep the divider as a horizontal line */
    @media (max-width: 720px){
    .twocol{
        grid-template-columns: 1fr;      /* one column */
        grid-template-rows: auto 1px auto; /* todo | line | completed */
        gap:0.9rem;                       /* gap above & below the divider */
    }
    .vline{
        width:100%;
        height:1px !important;           /* thin horizontal hairline */
        margin: .2rem 0;                  /* small extra breathing room */
    }
    }
  </style>
</head>
<body class="form-dashboard" style="display:none">
  <div class="header2">
    <h1 class="hero-title"><strong>Nothing to do? List</strong></h1>
  </div>
  <div class="welcome-banner" style="width:100%;max-width:1160px;margin:0 auto .5rem auto;text-align:center;">
    <p style="margin:.25rem 0;font-weight:600;color:#000;">Hey, <span id="welcome-name">User</span></p>
  </div>

  <div class="twocol">
    <!-- LEFT: To-Do -->
    <div class="list-col" id="todo-col">
      <div class="list-title">To-Do</div>
      <div id="todo-list"></div>
    </div>

    <!-- Center thin line -->
    <div class="vline"></div>

    <!-- RIGHT: Completed -->
    <div class="list-col" id="done-col">
      <div class="list-title">Completed</div>
      <div id="done-list"></div>
    </div>
  </div>

  <div class="logout"><button id="logout-btn">Logout</button></div>

  <script>
    // ===== Basic session & welcome =====
    (function(){
      if (!sessionStorage.getItem('loggedIn')) { document.body.style.display='none'; window.location.href='index.html'; return; }
      document.body.style.display='block';
      const n = sessionStorage.getItem('userName') || 'User';
      const wn = document.getElementById('welcome-name'); if (wn) wn.textContent = n;
    })();

    // ====== Per-business tasks (now supports per-task "days") =================
    // Key must match the dashboard filename WITHOUT .html
    // Example durations mixed: some 2 days, others 7 or 14
    const TASKS = {
      "ricks-diner": [
        { id:"deep-clean-drains",  title:"Deep clean drains",                 days:7 },
        { id:"descale-kettle",     title:"Descale kettle & urn",             days:14 },
        { id:"clean-extractor",    title:"Clean extractor hood filters",     days:7 },
        { id:"sanitize-cutting",   title:"Sanitize cutting boards",          days:2 },   // 2 days
        { id:"check-firstaid",     title:"Check first aid kit & dates",      days:7 }
      ],
      "phillys-cowley": [
        { id:"freezer-defrost",    title:"Defrost & clean freezer",          days:14 },
        { id:"descale-dishwasher", title:"Descale dishwasher",               days:7 },
        { id:"label-shelf",        title:"Refresh shelf/date labels",        days:2 }    // 2 days
      ],
      "phillys-stclements": [
        { id:"oven-clean",         title:"Clean ovens (inside & trays)",     days:7 },
        { id:"check-thermometers", title:"Check & sanitize thermometers",    days:2 }    // 2 days
      ],
      "stclaire-valentine": [
        { id:"wipe-seals",         title:"Wipe fridge door seals",           days:2 },   // 2 days
        { id:"stock-rotation",     title:"Full stock rotation check",        days:7 }
      ]
    };

    // ====== Optional Google Sheets logging ===================================
    const SHEETS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzlJDlp4KP2faug0IZKVFSmu41wr31fZzoKBN9RzVr5pspXe27HS81RRLXY4g7JXQ6U/exec"; // put your Apps Script web app URL here if you want logging
    async function logToSheets(payload){
    if (!SHEETS_WEB_APP_URL) return;
    try {
        await fetch(SHEETS_WEB_APP_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Webhook-Secret': DgRFY89aZXwjLHPw08LgAIzaSyBI0KCKvUjzJxu        // <— this must match Script Property
        },
        body: JSON.stringify(payload),
        mode: 'cors',
        keepalive: true
        });
    } catch(e) { /* ignore network errors */ }
    }

    // ====== Core logic (per-task durations) ==================================
    const DAY_MS = 24*60*60*1000;
    const businessFile = (sessionStorage.getItem('userBusiness') || '').replace(/\.html$/,'');
    const tasksForBiz  = TASKS[businessFile] || [];
    const userName = sessionStorage.getItem('userName') || 'Unknown';

    const KEY_PREFIX = 'todo:v2'; // bump version because we added per-task durations
    const keyFor = (tid) => `${KEY_PREFIX}:${businessFile}:${tid}`;

    function getTaskMeta(tid){ return tasksForBiz.find(t => t.id === tid) || { days:7 }; }
    function getPeriodMs(tid){ const d = Number(getTaskMeta(tid).days) || 7; return d * DAY_MS; }

    // DOM
    const todoList = document.getElementById('todo-list');
    const doneList = document.getElementById('done-list');

    // Build nodes
    const nodes = {};
    tasksForBiz.forEach(t => {
      const el = document.createElement('div');
      el.className = 'task';
      el.dataset.tid = t.id;
      el.innerHTML = `
        <div class="task-head">
          <div class="task-title">${t.title}</div>
          <span class="badge"></span>
        </div>
        <div class="meta"></div>
      `;
      nodes[t.id] = el;

      // Click -> complete
      el.addEventListener('click', () => handleComplete(t.id));

      // Long-press (2s) on completed -> undo
      let pressTimer = null;
      el.addEventListener('pointerdown', () => {
        if (!isCompleted(t.id)) return;
        pressTimer = setTimeout(() => handleUndo(t.id), 2000);
      });
      ['pointerup','pointerleave','pointercancel'].forEach(ev =>
        el.addEventListener(ev, () => { if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; }})
      );
    });

    // State helpers
    function getState(tid){
      try { return JSON.parse(localStorage.getItem(keyFor(tid))) || null; }
      catch(_) { return null; }
    }
    function setState(tid, st){ localStorage.setItem(keyFor(tid), JSON.stringify(st)); }
    function clearState(tid){ localStorage.removeItem(keyFor(tid)); }
    function isCompleted(tid){ return !!getState(tid)?.completedAt; }

    function msUntilReturn(tid){
      const st = getState(tid); if (!st) return null;
      const dueAt = new Date(st.completedAt).getTime() + getPeriodMs(tid);
      return dueAt - Date.now();
    }
    function daysUntilReturn(tid){
      const ms = msUntilReturn(tid); if (ms === null) return null;
      return Math.ceil(ms / DAY_MS);
    }
    function overdueDays(tid){
      const ms = msUntilReturn(tid); if (ms === null) return 0;
      if (ms > 0) return 0;
      return Math.floor((-ms) / DAY_MS) + 1; // "due 1 day ago" starts the day it passes
    }

    // Place + badges
    function placeTask(tid){
      const el = nodes[tid];
      const st = getState(tid);
      const badge = el.querySelector('.badge');
      const meta  = el.querySelector('.meta');

      if (!st) {
        badge.textContent = ''; badge.classList.remove('warn'); meta.textContent = '';
        todoList.appendChild(el);
        return;
      }

      const od = overdueDays(tid);
      if (od > 0) {
        // Overdue → back to To-Do automatically (and show overdue & last done)
        clearState(tid);
        badge.textContent = `due ${od} day${od>1?'s':''} ago`;
        badge.classList.add('warn');
        meta.textContent = st.by ? `Last done by ${st.by} on ${new Date(st.completedAt).toLocaleDateString()}` : '';
        todoList.appendChild(el);
      } else {
        // Still within period → Completed
        const left = daysUntilReturn(tid);
        const d = Number(getTaskMeta(tid).days) || 7;
        badge.textContent = left ? `returns in ${left} / ${d} day${d>1?'s':''}` : `returns today`;
        badge.classList.remove('warn');
        meta.innerHTML = st.by
          ? `<span class="who">✔ finished by ${st.by}</span> <span class="date">• ${new Date(st.completedAt).toLocaleDateString()}</span>`
          : '';
        doneList.appendChild(el);
      }
    }

    function handleComplete(tid){
      if (isCompleted(tid)) return;
      const state = { completedAt: new Date().toISOString(), by: userName };
      setState(tid, state);
      placeTask(tid);
      logToSheets({
        action:'complete', business:businessFile, taskId:tid,
        taskTitle:getTaskMeta(tid).title || tid, by:userName, at:state.completedAt,
        days:getTaskMeta(tid).days || 7
      });
    }

    function handleUndo(tid){
      const prev = getState(tid);
      clearState(tid);
      placeTask(tid);
      logToSheets({
        action:'undo', business:businessFile, taskId:tid,
        taskTitle:getTaskMeta(tid).title || tid, by:userName,
        at:new Date().toISOString(), prevCompletedAt: prev?.completedAt || null
      });
    }

    // Sort To-Do by urgency: most overdue first, then longest since last completed
    function sortTodo(){
      const cards = Array.from(todoList.children);
      cards.sort((a,b)=>{
        const ta=a.dataset.tid, tb=b.dataset.tid;
        const oa = overdueDays(ta), ob = overdueDays(tb);
        if (ob !== oa) return ob - oa; // more overdue first
        const sa = getState(ta), sb = getState(tb);
        const ea = sa ? Date.now() - new Date(sa.completedAt).getTime() : 0;
        const eb = sb ? Date.now() - new Date(sb.completedAt).getTime() : 0;
        return eb - ea; // older completion first
      });
      cards.forEach(c => todoList.appendChild(c));
    }

    function renderAll(){
      if (tasksForBiz.length === 0){
        todoList.innerHTML = `<div class="empty">No tasks configured for this business yet.</div>`;
        doneList.innerHTML = '';
        return;
      }
      todoList.innerHTML = ''; doneList.innerHTML = '';
      tasksForBiz.forEach(t => placeTask(t.id));
      sortTodo();
    }
    renderAll();

    // Refresh every minute to update countdowns / auto-return
    setInterval(()=>{ tasksForBiz.forEach(t => placeTask(t.id)); sortTodo(); }, 60*1000);

    // logout
    document.getElementById('logout-btn').addEventListener('click', () => {
      sessionStorage.clear(); window.location.href = 'index.html';
    });
  </script>

  <!-- Shared inactivity timer & protections -->
  <script src="disposal.js" defer></script>
</body>
</html>
